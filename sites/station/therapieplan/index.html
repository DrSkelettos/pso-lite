---
layout: layout.html
active_therapieplan: active
title: Therapieplan
include_navigation: true
dir: ../../../
save_data: therapieplaene
save_file: therapieplaene
---

<script src="{{ dir }}src/station/announcements.js"></script>

<style>
    .week-current {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
</style>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>Therapieplan</h1>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Wochen√ºbersicht</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered table-hover mb-0" id="therapyPlanTable">
                        <thead>
                            <tr>
                                <th width="80" class="text-center">KW</th>
                                <th width="200">Zeitraum</th>
                                <th>Aktiver Therapieplan</th>
                            </tr>
                        </thead>
                        <tbody id="therapyPlanTableBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.addEventListener('baseDataLoaded', async function () {
        loadMultipleData(['therapieplaene'], function (result) {
            // Initialize empty object if not loaded
            if (!window['therapieplaene']) {
                window['therapieplaene'] = { plans: { default: { title: 'Normaler Therapieplan' } }, station: {} };
            }
            if (!window['therapieplaene'].station) {
                window['therapieplaene'].station = {};
            }

            renderTherapyPlanTable();
        });
    });

    function renderTherapyPlanTable() {
        const tbody = document.getElementById('therapyPlanTableBody');
        tbody.innerHTML = '';

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const currentWeek = getCalendarWeek(today);
        const currentWeekYear = getWeekYear(today);

        // Calculate weeks to show: 2 weeks back, rest of year + min 25 weeks ahead
        const weeks = getWeeksToDisplay(today);

        weeks.forEach(({ year, week }) => {
            const monday = getMondayOfWeek(year, week);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const weekKey = `${year}-${week}`;
            const currentPlanKey = window['therapieplaene'].station[weekKey] || 'default';
            const currentPlan = window['therapieplaene'].plans[currentPlanKey] || window['therapieplaene'].plans['default'];

            const tr = document.createElement('tr');
            
            // Highlight current week
            if (year === currentWeekYear && week === currentWeek) {
                tr.classList.add('week-current');
            }

            // KW column
            const tdKW = document.createElement('td');
            tdKW.className = 'text-center';
            tdKW.textContent = week;
            tr.appendChild(tdKW);

            // Date range column
            const tdDates = document.createElement('td');
            tdDates.textContent = `${formatDateShort(monday)} - ${formatDateShort(sunday)}`;
            tr.appendChild(tdDates);

            // Plan column with dropdown
            const tdPlan = document.createElement('td');
            
            if (authorize('editTherapyplanStation')) {
                const select = document.createElement('select');
                select.className = 'form-select form-select-sm';
                select.dataset.weekKey = weekKey;

                // Add options
                for (const [planKey, plan] of Object.entries(window['therapieplaene'].plans)) {
                    const option = document.createElement('option');
                    option.value = planKey;
                    option.textContent = plan.title;
                    if (planKey === currentPlanKey) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }

                select.addEventListener('change', function() {
                    updateWeekPlan(this.dataset.weekKey, this.value);
                });

                tdPlan.appendChild(select);
            } else {
                tdPlan.textContent = currentPlan?.title || 'Normaler Therapieplan';
            }
            
            tr.appendChild(tdPlan);
            tbody.appendChild(tr);
        });
    }

    function getWeeksToDisplay(today) {
        const weeks = [];
        const currentWeek = getCalendarWeek(today);
        const currentYear = getWeekYear(today);

        // Start 2 weeks back
        let startDate = new Date(today);
        startDate.setDate(today.getDate() - 14);

        // End at least 25 weeks ahead or end of year, whichever is later
        const minEndDate = new Date(today);
        minEndDate.setDate(today.getDate() + 25 * 7);
        
        const endOfYear = new Date(currentYear, 11, 31);
        const endDate = minEndDate > endOfYear ? minEndDate : endOfYear;

        // Collect all weeks
        const seenWeeks = new Set();
        const current = new Date(startDate);

        while (current <= endDate) {
            const week = getCalendarWeek(current);
            const year = getWeekYear(current);
            const key = `${year}-${week}`;

            if (!seenWeeks.has(key)) {
                seenWeeks.add(key);
                weeks.push({ year, week });
            }

            current.setDate(current.getDate() + 7);
        }

        return weeks;
    }

    function getMondayOfWeek(year, week) {
        // Find first Thursday of the year (ISO week date system)
        const jan4 = new Date(year, 0, 4);
        const dayOfWeek = jan4.getDay() || 7;
        const firstMonday = new Date(jan4);
        firstMonday.setDate(jan4.getDate() - dayOfWeek + 1);

        // Add weeks
        const targetMonday = new Date(firstMonday);
        targetMonday.setDate(firstMonday.getDate() + (week - 1) * 7);

        return targetMonday;
    }

    function getWeekYear(date) {
        const target = new Date(date.valueOf());
        target.setHours(0, 0, 0, 0);
        const dayNr = (date.getDay() + 6) % 7;
        target.setDate(target.getDate() - dayNr + 3);
        return target.getFullYear();
    }

    function formatDateShort(date) {
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        return `${day}.${month}.`;
    }

    function updateWeekPlan(weekKey, planKey) {
        if (!window['therapieplaene'].station) {
            window['therapieplaene'].station = {};
        }

        if (planKey === 'default') {
            // Remove entry if setting to default
            delete window['therapieplaene'].station[weekKey];
        } else {
            window['therapieplaene'].station[weekKey] = planKey;
        }

        checkData();
    }
</script>
