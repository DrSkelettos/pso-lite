---
layout: layout.html
title: Mitarbeiter:innen
active_mitarbeiterinnen: active
include_navigation: true
dir: ../../
save_data: employees
save_file: mitarbeiter_innen
---

<script src="{{ dir }}src/employees.js"></script>
<script src="{{ dir }}src/station/announcements.js"></script>

<div class="container-fluid">
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Mitarbeiter:innen</h5>
                    <button type="button" id="addEmployeeButton" class="btn btn-primary btn-sm hidden" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
                        <i class="bi bi-plus-lg me-1 text-light"></i>Mitarbeiter:in hinzufügen
                    </button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th width=100>Name</th>
                                <th width=50>Kürzel</th>
                                <th width="100">Patient:innen</th>
                                <th>Abwesenheiten</th>
                                <th width="100"></th>
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% include "mitarbeiterinnen/addEmployee.html" %}
{% include "mitarbeiterinnen/editEmployee.html" %}

<script>
    // Override saveData function for mitarbeiterinnen page
    const originalSaveData = window.saveData;
    window.saveData = async function(objectName, fileName) {
        if (objectName === 'employees') {
            // Apply pending announcement changes before saving
            if (window['pendingAnnouncementChanges']) {
                // Remove old announcements (only future ones)
                window['pendingAnnouncementChanges'].toRemove.forEach(old => {
                    if (typeof removeAnnouncementEntriesForEmployee === 'function') {
                        removeAnnouncementEntriesForEmployee(old.announcementDate, old.employeeKey, old.startDate, old.endDate);
                    }
                });

                // Create new announcements
                window['pendingAnnouncementChanges'].toCreate.forEach(announcement => {
                    if (typeof generateAnnouncementContent === 'function' && typeof addAnnouncementEntry === 'function') {
                        const content = generateAnnouncementContent(
                            announcement.employeeKey,
                            announcement.startDate,
                            announcement.endDate
                        );

                        // Only create announcement if there's content (employee has template)
                        if (content) {
                            addAnnouncementEntry(announcement.announcementDate, {
                                content: content,
                                employee: announcement.employeeKey,
                                start_date: announcement.startDate,
                                end_date: announcement.endDate,
                                checked: false
                            });
                        }
                    }
                });

                // Clear pending changes
                delete window['pendingAnnouncementChanges'];
            }
            
            // Save employees data
            await saveFile('mitarbeiter_innen', window['employees']);
            setOriginalData('employees');
            
            // Save announcements data if it has changed
            if (original['announcements-station'] !== JSON.stringify(window['announcements-station'])) {
                await saveFile('ankuendigungen-station', window['announcements-station']);
                setOriginalData('announcements-station');
            }
            
            // Hide the save button
            if (document.getElementById("data-changed")) {
                document.getElementById("data-changed").classList.add("d-none");
            }
        } else {
            // Use original saveData for other data types
            return originalSaveData(objectName, fileName);
        }
    };

    window.addEventListener('baseDataLoaded', () => {
        // Load announcements data so we can create announcements when saving absences
        loadMultipleData(['announcements-station'], function(result) {
            // Initialize empty object if not loaded
            if (!window['announcements-station']) {
                window['announcements-station'] = {};
            }
            // Set initial state for announcements data
            setOriginalData('announcements-station');
            fillEmployeesTable();
        });
    });
</script>